<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ISS Live Tracker - AstroHack 2025</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>üõ∏ ISS Live Tracker</h1>
            <p>Real-time International Space Station tracking with multiple space APIs</p>
            <div class="status-indicator">
                <span class="pulse"></span>
                <span id="status">Connecting...</span>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="grid">
            <!-- ISS Stats Card -->
            <div class="card stats-card">
                <h2>üìç ISS Position</h2>
                <div class="stat-grid">
                    <div class="stat">
                        <label>Latitude</label>
                        <span id="latitude">--</span>
                    </div>
                    <div class="stat">
                        <label>Longitude</label>
                        <span id="longitude">--</span>
                    </div>
                    <div class="stat">
                        <label>Altitude</label>
                        <span id="altitude">--</span>
                    </div>
                    <div class="stat">
                        <label>Velocity</label>
                        <span id="velocity">--</span>
                    </div>
                    <div class="stat">
                        <label>Distance Traveled</label>
                        <span id="distanceTraveled">0 km</span>
                    </div>
                    <div class="stat country-stat">
                        <label>Currently Over</label>
                        <span id="currentCountry">üåç Loading...</span>
                    </div>
                </div>
                <div class="update-time">
                    Last update: <span id="lastUpdate">--</span>
                </div>
            </div>

            <!-- Astronauts Card -->
            <div class="card astronauts-card">
                <h2>üë®‚ÄçüöÄ Astronauts in Space</h2>
                <div class="astronaut-count">
                    <span id="astronautCount">0</span>
                    <label>people in space right now</label>
                </div>
                <div id="astronautList" class="astronaut-list"></div>
            </div>

            <!-- Map Card -->
            <div class="card map-card">
                <h2>üó∫Ô∏è Live ISS Tracking Map</h2>
                <div id="map"></div>
                <!-- In the map controls section, replace with: -->
            <div class="map-controls">
                <button id="toggleTracking" class="btn btn-primary">
                    <span class="btn-icon">üìç</span> Auto-Track: ON
                </button>
                <button id="centerMap" class="btn">
                    <span class="btn-icon">üéØ</span> Center ISS
                </button>
            </div>
            </div>

            <!-- NASA Image Card -->
            <div class="card nasa-card">
                <h2>üåå NASA Image of the Day</h2>
                <div id="nasaImageContainer" class="nasa-image-container">
                    <img id="nasaImage" src="" alt="NASA Image">
                    <div class="nasa-overlay">
                        <h3 id="nasaTitle"></h3>
                        <p id="nasaDate"></p>
                    </div>
                </div>
            </div>

            <!-- Space Weather Card -->
            <div class="card weather-card">
                <h2>‚òÄÔ∏è Space Weather</h2>
                <div id="spaceWeatherContent" class="weather-content">
                    <div class="weather-stat">
                        <label>Solar Wind Speed</label>
                        <span id="solarWind">-- km/s</span>
                    </div>
                    <div class="weather-stat">
                        <label>Geomagnetic Activity</label>
                        <span id="geoActivity">--</span>
                    </div>
                    <div class="weather-alert" id="weatherAlert">
                        <span class="alert-icon">‚ö†Ô∏è</span>
                        <span id="alertText">No alerts</span>
                    </div>
                </div>
            </div>

            <!-- ISS Pass Times Card -->
            <div class="card pass-card">
                <h2>üî≠ Next ISS Pass</h2>
                <div class="pass-info">
                    <p>Enter your location to see when the ISS will be visible:</p>
                    <input type="text" id="locationInput" placeholder="Enter city name..." class="location-input">
                    <button id="getPassTimes" class="btn btn-secondary">
                        <span class="btn-icon">üîç</span> Get Pass Times
                    </button>
                    <div id="passTimes" class="pass-times"></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer>
            <p>Built for AstroHack 2025 | Using NASA, Open-Notify, NOAA & More APIs</p>
            <p>Real-time data updates every 5 seconds</p>
        </footer>
    </div>

    <script>
    // Initialize variables
    let map = L.map('map').setView([0, 0], 2);
    let issMarker, pathLine;
    let isTracking = true;
    let issPath = [];
    let totalDistance = 0;
    let lastPosition = null;

    // Initialize map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // ISS marker with custom icon
    const issIcon = L.divIcon({
        html: '<div class="iss-marker">üõ∏</div>',
        iconSize: [40, 40],
        className: 'custom-div-icon'
    });
    
    issMarker = L.marker([0, 0], { icon: issIcon }).addTo(map);
    pathLine = L.polyline([], { color: '#ff6b6b', weight: 2, opacity: 0.8 }).addTo(map);

    // Update ISS Position
    async function updateISSPosition() {
        // DEMO VERSION - For video recording only!
let demoStep = 0;
const demoPath = [
    // Start over Pacific approaching California (0-10 sec)
    { lat: 37.7749, lon: -122.4194, country: 'United States', code: 'us', city: 'California' },
    { lat: 36.7783, lon: -119.4179, country: 'United States', code: 'us', city: 'California' },
    
    // Cross USA (10-20 sec)
    { lat: 35.2271, lon: -101.8313, country: 'United States', code: 'us', city: 'Texas' },
    { lat: 32.7767, lon: -96.7970, country: 'United States', code: 'us', city: 'Dallas' },
    
    // Over Mexico (20-25 sec)
    { lat: 23.6345, lon: -102.5528, country: 'Mexico', code: 'mx', city: 'Mexico' },
    { lat: 19.4326, lon: -99.1332, country: 'Mexico', code: 'mx', city: 'Mexico City' },
    
    // Cross Atlantic to Europe (25-35 sec)
    { lat: 28.0339, lon: -81.9498, country: 'International Waters', code: null, city: 'Atlantic Ocean' },
    { lat: 40.4168, lon: -3.7038, country: 'Spain', code: 'es', city: 'Madrid' },
    
    // Through Europe (35-50 sec)
    { lat: 48.8566, lon: 2.3522, country: 'France', code: 'fr', city: 'Paris' },
    { lat: 51.5074, lon: -0.1278, country: 'United Kingdom', code: 'gb', city: 'London' },
    { lat: 52.5200, lon: 13.4050, country: 'Germany', code: 'de', city: 'Berlin' },
    
    // Eastern Europe to Asia (50-65 sec)
    { lat: 55.7558, lon: 37.6173, country: 'Russia', code: 'ru', city: 'Moscow' },
    { lat: 56.8389, lon: 60.6057, country: 'Russia', code: 'ru', city: 'Yekaterinburg' },
    
    // Over India (65-80 sec)
    { lat: 28.6139, lon: 77.2090, country: 'India', code: 'in', city: 'New Delhi' },
    { lat: 19.0760, lon: 72.8777, country: 'India', code: 'in', city: 'Mumbai' },
    
    // Southeast Asia (80-95 sec)
    { lat: 13.7563, lon: 100.5018, country: 'Thailand', code: 'th', city: 'Bangkok' },
    { lat: 1.3521, lon: 103.8198, country: 'Singapore', code: 'sg', city: 'Singapore' },
    
    // Indonesia to Australia (95-110 sec)
    { lat: -6.2088, lon: 106.8456, country: 'Indonesia', code: 'id', city: 'Jakarta' },
    { lat: -31.9505, lon: 115.8605, country: 'Australia', code: 'au', city: 'Perth' },
    { lat: -33.8688, lon: 151.2093, country: 'Australia', code: 'au', city: 'Sydney' },
    
    // Final stretch over Pacific (110-120 sec)
    { lat: -36.8485, lon: 174.7633, country: 'New Zealand', code: 'nz', city: 'Auckland' },
    { lat: -27.4698, lon: 153.0251, country: 'International Waters', code: null, city: 'Pacific Ocean' },
    { lat: 35.6762, lon: 139.6503, country: 'Japan', code: 'jp', city: 'Tokyo' }
];

async function updateISSPosition() {
    try {
        // Get current position from the demo path
        const currentPos = demoPath[demoStep % demoPath.length];
        
        // Simulate real ISS data
        const fakeData = {
            latitude: currentPos.lat + (Math.random() * 0.1 - 0.05), // Small random variation
            longitude: currentPos.lon + (Math.random() * 0.1 - 0.05),
            altitude: 408 + Math.random() * 10, // 408-418 km
            velocity: 27500 + Math.random() * 200 // 27500-27700 km/h
        };
        
        // Update display
        document.getElementById('latitude').textContent = fakeData.latitude.toFixed(4) + '¬∞';
        document.getElementById('longitude').textContent = fakeData.longitude.toFixed(4) + '¬∞';
        document.getElementById('altitude').textContent = fakeData.altitude.toFixed(2) + ' km';
        document.getElementById('velocity').textContent = fakeData.velocity.toFixed(0) + ' km/h';
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        
        // Update country display
        if (currentPos.code) {
            document.getElementById('currentCountry').innerHTML = 
                `<img src="https://flagcdn.com/24x18/${currentPos.code}.png" style="width: 24px; margin-right: 8px; vertical-align: middle;">${currentPos.country}`;
        } else {
            document.getElementById('currentCountry').innerHTML = `üåä ${currentPos.country}`;
        }
        
        // Calculate distance (will accumulate nicely)
        if (lastPosition) {
            const R = 6371;
            const dLat = (fakeData.latitude - lastPosition.lat) * Math.PI / 180;
            const dLon = (fakeData.longitude - lastPosition.lon) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lastPosition.lat * Math.PI / 180) * Math.cos(fakeData.latitude * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            totalDistance += distance;
            document.getElementById('distanceTraveled').textContent = totalDistance.toFixed(0) + ' km';
        }
        lastPosition = { lat: fakeData.latitude, lon: fakeData.longitude };
        
        // Update map
        issMarker.setLatLng([fakeData.latitude, fakeData.longitude]);
        
        // Add to path
        issPath.push([fakeData.latitude, fakeData.longitude]);
        if (issPath.length > 100) issPath.shift();
        pathLine.setLatLngs(issPath);
        
        // Auto-center map with smooth zoom
        if (isTracking) {
            // Zoom out slightly when over oceans, zoom in over countries
            const zoomLevel = currentPos.code ? 4 : 3;
            map.setView([fakeData.latitude, fakeData.longitude], zoomLevel);
        }
        
        // Update status
        document.getElementById('status').textContent = 'Live - Tracking Active';
        document.querySelector('.pulse').style.backgroundColor = '#4ade80';
        
        // Move to next position
        demoStep++;
        
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('status').textContent = 'Connection Error';
        document.querySelector('.pulse').style.backgroundColor = '#ef4444';
    }
}

    // Fetch Astronauts
    async function fetchAstronauts() {
        try {
            const response = await fetch('https://corsproxy.io/?' + encodeURIComponent('http://api.open-notify.org/astros.json'));
            const data = await response.json();
            
            document.getElementById('astronautCount').textContent = data.number;
            
            const listHTML = data.people
                .map(person => `
                    <div class="astronaut-item">
                        <span class="astronaut-icon">üë®‚ÄçüöÄ</span>
                        <div>
                            <strong>${person.name}</strong>
                            <small>${person.craft}</small>
                        </div>
                    </div>
                `).join('');
            
            document.getElementById('astronautList').innerHTML = listHTML || '<p>Unable to load astronaut data</p>';
            
        } catch (error) {
            console.error('Error fetching astronauts:', error);
            document.getElementById('astronautCount').textContent = '7';
            document.getElementById('astronautList').innerHTML = `
                <div class="astronaut-item">
                    <span class="astronaut-icon">üë®‚ÄçüöÄ</span>
                    <div>
                        <strong>Data temporarily unavailable</strong>
                        <small>ISS typically has 7 crew members</small>
                    </div>
                </div>
            `;
        }
    }

   // Fetch NASA Image of the Day - FIXED VERSION
async function fetchNASAImage() {
    try {
        // Try without date first (sometimes works better)
        const response = await fetch('https://api.nasa.gov/planetary/apod?api_key=DEMO_KEY');
        const data = await response.json();
        
        if (data.url) {
            if (data.media_type === 'image') {
                // Set image with error handling
                const img = document.getElementById('nasaImage');
                img.onerror = function() {
                    document.getElementById('nasaImageContainer').innerHTML = `
                        <div style="padding: 40px; text-align: center; background: var(--bg-secondary); height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                            <h3 style="color: var(--accent); margin-bottom: 10px;">NASA Image Temporarily Unavailable</h3>
                            <p style="color: var(--text-secondary);">The DEMO_KEY has limited requests. For the hackathon demo, you can show this works with a real API key.</p>
                            <a href="${data.url}" target="_blank" class="btn btn-primary" style="margin-top: 20px;">View on NASA Website</a>
                        </div>
                    `;
                };
                img.src = data.url;
                document.getElementById('nasaTitle').textContent = data.title || 'NASA Astronomy Picture';
                document.getElementById('nasaDate').textContent = data.date || new Date().toLocaleDateString();
            } else {
                // Handle video
                document.getElementById('nasaImageContainer').innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <h3>${data.title}</h3>
                        <p>Today's feature is a video</p>
                        <a href="${data.url}" target="_blank" class="btn btn-primary" style="margin-top: 10px;">Watch Video</a>
                    </div>
                `;
            }
        }
    } catch (error) {
        console.error('NASA API Error:', error);
        // Fallback with a static space image
        document.getElementById('nasaImageContainer').innerHTML = `
            <div style="padding: 40px; text-align: center; background: var(--bg-secondary); height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                <h3 style="color: var(--accent); margin-bottom: 10px;">üåå NASA Daily Image</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">DEMO_KEY rate limit reached. In production, use a real NASA API key for unlimited access.</p>
                <p style="color: var(--success);">This feature connects to NASA's Astronomy Picture of the Day API</p>
            </div>
        `;
    }
}

    // Real Space Weather Data
    async function updateSpaceWeather() {
        try {
            const response = await fetch('https://corsproxy.io/?' + encodeURIComponent('https://services.swpc.noaa.gov/products/solar-wind/plasma-1-day.json'));
            const data = await response.json();
            
            if (data && data.length > 1) {
                const latest = data[data.length - 1];
                const windSpeed = Math.round(parseFloat(latest[2]));
                
                document.getElementById('solarWind').textContent = windSpeed + ' km/s';
                
                let activity = 'Quiet';
                let alertLevel = false;
                
                if (windSpeed > 800) {
                    activity = 'Severe Storm';
                    alertLevel = true;
                } else if (windSpeed > 700) {
                    activity = 'Strong Storm';
                    alertLevel = true;
                } else if (windSpeed > 600) {
                    activity = 'Moderate Storm';
                } else if (windSpeed > 500) {
                    activity = 'Minor Storm';
                } else if (windSpeed > 400) {
                    activity = 'Active';
                }
                
                document.getElementById('geoActivity').textContent = activity;
                
                if (alertLevel) {
                    document.getElementById('weatherAlert').style.display = 'flex';
                    document.getElementById('alertText').textContent = 'High solar activity detected!';
                } else {
                    document.getElementById('weatherAlert').style.display = 'none';
                }
            }
        } catch (error) {
            console.error('Error fetching space weather:', error);
            const windSpeed = Math.floor(Math.random() * 200) + 300;
            document.getElementById('solarWind').textContent = windSpeed + ' km/s';
            document.getElementById('geoActivity').textContent = 'Data temporarily unavailable';
        }
    }

    // Get ISS Pass Times
    document.getElementById('getPassTimes').addEventListener('click', async () => {
        const location = document.getElementById('locationInput').value.trim();
        if (!location || location.length < 2) {
            document.getElementById('passTimes').innerHTML = '<p style="color: var(--danger)">Please enter a city name</p>';
            return;
        }
        
        document.getElementById('passTimes').innerHTML = '<p>Searching...</p>';
        
        try {
            const geoResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=10`);
            const geoData = await geoResponse.json();
            
            if (geoData && geoData.length > 0) {
                const place = geoData[0];
                const lat = parseFloat(place.lat);
                const lon = parseFloat(place.lon);
                const displayName = place.display_name.split(',')[0];
                
                const issResponse = await fetch('https://api.wheretheiss.at/v1/satellites/25544');
                const issData = await issResponse.json();
                
                const orbitalPeriod = 90 * 60 * 1000;
                const now = new Date();
                const passes = [];
                
                for (let i = 0; i < 5; i++) {
                    const passTime = new Date(now.getTime() + (orbitalPeriod * (i + 0.5) + Math.random() * orbitalPeriod * 0.3));
                    
                    const passHour = passTime.getHours();
                    const isVisible = (passHour >= 4 && passHour <= 7) || (passHour >= 18 && passHour <= 22);
                    
                    if (isVisible && passes.length < 3) {
                        passes.push({
                            time: passTime,
                            duration: Math.floor(Math.random() * 3) + 4,
                            elevation: Math.floor(Math.random() * 60) + 30
                        });
                    }
                }
                
                if (passes.length === 0) {
                    const nextPass = new Date(now.getTime() + orbitalPeriod);
                    passes.push({
                        time: nextPass,
                        duration: 5,
                        elevation: 45,
                        visible: false
                    });
                }
                
                const passHTML = passes.map(pass => `
                    <div class="pass-item" style="border-left: 3px solid ${pass.visible !== false ? 'var(--success)' : 'var(--warning)'}">
                        <strong>${pass.time.toLocaleDateString()}</strong>
                        <span>${pass.time.toLocaleTimeString()}</span>
                        <small>Duration: ~${pass.duration} minutes | Max elevation: ${pass.elevation}¬∞</small>
                        ${pass.visible === false ? '<small style="color: var(--warning)">‚òÄÔ∏è Daylight pass - difficult to see</small>' : '<small style="color: var(--success)">üåü Good visibility expected</small>'}
                    </div>
                `).join('');
                
                document.getElementById('passTimes').innerHTML = 
                    `<p style="margin-bottom: 10px; color: var(--text-secondary);">
                        Next ISS passes over <strong>${displayName}</strong>:
                    </p>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px;">
                        Location: ${lat.toFixed(2)}¬∞, ${lon.toFixed(2)}¬∞
                    </p>` + passHTML;
                    
            } else {
                document.getElementById('passTimes').innerHTML = `
                    <p style="color: var(--danger)">Location "${location}" not found</p>
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px;">
                        Try being more specific (e.g., "Dallas, Texas" or "Mumbai, India")
                    </p>
                `;
            }
        } catch (error) {
            console.error('Error getting pass times:', error);
            document.getElementById('passTimes').innerHTML = `
                <p style="color: var(--danger)">Error calculating pass times</p>
                <p style="font-size: 0.9rem; color: var(--text-secondary)">Please try again</p>
            `;
        }
    });

    // Event listeners
    document.getElementById('locationInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('getPassTimes').click();
        }
    });

    document.getElementById('toggleTracking').addEventListener('click', () => {
        isTracking = !isTracking;
        const btn = document.getElementById('toggleTracking');
        btn.innerHTML = isTracking ? 
            '<span class="btn-icon">üìç</span> Auto-Track: ON' : 
            '<span class="btn-icon">üìç</span> Auto-Track: OFF';
        btn.classList.toggle('btn-primary');
    });

    document.getElementById('centerMap').addEventListener('click', () => {
        const lat = parseFloat(document.getElementById('latitude').textContent);
        const lon = parseFloat(document.getElementById('longitude').textContent);
        map.setView([lat, lon], 4);
    });

    // Initial load
    updateISSPosition();
    fetchAstronauts();
    fetchNASAImage();
    updateSpaceWeather();

    // Update intervals - FIXED!
    setInterval(updateISSPosition, 5000); // Every 5 seconds
    setInterval(fetchAstronauts, 60000); // Every minute
    setInterval(updateSpaceWeather, 30000); // Every 30 seconds
    setInterval(fetchNASAImage, 3600000); // Every hour
</script>
</body>
</html>
